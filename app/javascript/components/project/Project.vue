<template>
  <div>
    <b-breadcrumb :items="breadcrumbs" />
    <b-row class="align-items-center">
      <b-col md="8">
        <div class="d-flex justify-content-start">
          <h1>{{ project.name }}</h1>
          <b-badge pill variant="info" class="w-15 h-25">{{ project.visibility }} </b-badge>
          <div v-if="role_gte_to(effective_permissions, 'admin')">
            <b-form-checkbox
              v-model="visible"
              v-b-modal.confirm-visibility-change
              switch
              size="lg"
              class="ml-2"
            >
              <small>{{ visible ? "Switch back to private" : "Mark as discoverable" }}</small>
            </b-form-checkbox>
            <b-modal
              id="confirm-visibility-change"
              title="Confirm Visibility Change"
              @ok="updateVisibility"
              @hide="visible = project.visibility === 'discoverable'"
            >
              Are you sure you want to change the visibility of this project to
              <mark>{{ visible ? "discoverable" : "hidden" }} </mark>?
            </b-modal>
          </div>
        </div>
      </b-col>
      <b-col md="4" class="text-muted text-md-right">
        <p v-if="lastAudit" class="text-muted mb-1">
          <template v-if="lastAudit.created_at">
            Last update on {{ friendlyDateTime(lastAudit.created_at) }}
          </template>
          <template v-if="lastAudit.user_id"> by {{ lastAudit.user_id }} </template>
        </p>
        <p class="mb-1">
          <span v-if="project.admin_name">
            {{ project.admin_name }}
            {{ project.admin_email ? `(${project.admin_email})` : "" }}
          </span>
          <em v-else>No Project Admin</em>
        </p>
      </b-col>
    </b-row>

    <b-row>
      <b-col md="10" class="border-right">
        <!-- Tab view for project information -->
        <b-tabs v-model="projectTabIndex" content-class="mt-3" justified>
          <!-- Project components -->
          <b-tab :title="`Components (${project.components.length})`">
            <h2>Project Components</h2>
            <div>
              <NewComponentModal
                v-if="role_gte_to(effective_permissions, 'admin')"
                :project_id="project.id"
                :project="project"
                @projectUpdated="refreshProject"
              />
              <NewComponentModal
                v-if="role_gte_to(effective_permissions, 'admin')"
                :project_id="project.id"
                :project="project"
                :spreadsheet_import="true"
                @projectUpdated="refreshProject"
              />
              <NewComponentModal
                v-if="role_gte_to(effective_permissions, 'admin')"
                :project_id="project.id"
                :project="project"
                :copy_component="true"
                @projectUpdated="refreshProject"
              />
              <b-dropdown right text="Download" variant="secondary" class="px-2 m2">
                <b-dropdown-item v-b-modal.disa-excel-export-modal>
                  DISA Excel Export
                </b-dropdown-item>
                <b-dropdown-item v-b-modal.excel-export-modal>Excel Export</b-dropdown-item>
                <b-dropdown-item @click="downloadExport('inspec')">InSpec Profile</b-dropdown-item>
                <b-dropdown-item @click="downloadExport('xccdf')">Xccdf Export</b-dropdown-item>
              </b-dropdown>

              <b-modal
                id="excel-export-modal"
                ref="excel-export-modal"
                title="Excel Export"
                centered
              >
                <p class="my-2">
                  Would you like to export all components in this project or just the released
                  components?
                </p>
                <template #modal-footer>
                  <b-button @click="downloadExport('excel', 'all')">
                    Export all components
                  </b-button>
                  <b-button @click="downloadExport('excel', 'released')">
                    Export released Components
                  </b-button>
                </template>
              </b-modal>

              <b-modal
                id="disa-excel-export-modal"
                ref="disa-excel-export-modal"
                title="DISA Excel Export"
                centered
              >
                <p class="my-2">
                  Would you like to export all components in this project or just the released
                  components?
                </p>
                <template #modal-footer>
                  <b-button @click="downloadExport('disa_excel', 'all')">
                    Export all components
                  </b-button>
                  <b-button @click="downloadExport('disa_excel', 'released')">
                    Export released Components
                  </b-button>
                </template>
              </b-modal>
            </div>
            <b-row cols="1" cols-sm="1" cols-md="1" cols-lg="2">
              <b-col v-for="component in sortedRegularComponents()" :key="component.id">
                <ComponentCard
                  :component="component"
                  :effective-permissions="effective_permissions"
                  @deleteComponent="deleteComponent($event)"
                  @projectUpdated="refreshProject"
                />
              </b-col>
            </b-row>

            <h2>Overlaid Components</h2>
            <AddComponentModal
              v-if="role_gte_to(effective_permissions, 'admin')"
              :project_id="project.id"
              :available_components="sortedAvailableComponents"
              @projectUpdated="refreshProject"
            />
            <b-row cols="1" cols-sm="1" cols-md="1" cols-lg="2">
              <b-col v-for="component in sortedOverlayComponents()" :key="component.id">
                <ComponentCard
                  :component="component"
                  :effective-permissions="effective_permissions"
                  @deleteComponent="deleteComponent($event)"
                  @projectUpdated="refreshProject"
                />
              </b-col>
            </b-row>
          </b-tab>

          <!-- Diff View -->
          <b-tab title="Diff Viewer" lazy>
            <DiffViewer :project="initialProjectState" />
          </b-tab>

          <!-- Revision History -->
          <b-tab title="Revision History">
            <RevisionHistory
              :project="initialProjectState"
              :unique-component-names="uniqueComponentNames"
            />
          </b-tab>

          <!-- Project members -->
          <b-tab :title="`Members (${project.memberships_count})`">
            <template #title>
              <div class="position-relative">
                Members ({{ project.memberships_count }})
                <b-badge
                  v-if="
                    role_gte_to(effective_permissions, 'admin') &&
                    project.access_requests.length > 0
                  "
                  pill
                  variant="info"
                >
                  pending request
                </b-badge>
              </div>
            </template>
            <MembershipsTable
              :editable="role_gte_to(effective_permissions, 'admin')"
              :membership_type="'Project'"
              :membership_id="project.id"
              :memberships="project.memberships"
              :memberships_count="project.memberships_count"
              :available_members="project.available_members"
              :available_roles="available_roles"
              :access_requests="project.access_requests"
            />
          </b-tab>
        </b-tabs>
      </b-col>
      <b-col md="2">
        <b-row class="pb-4">
          <b-col>
            <div class="clickable" @click="showDetails = !showDetails">
              <h5 class="m-0 d-inline-block">Project Details</h5>

              <i v-if="showDetails" class="mdi mdi-menu-down superVerticalAlign collapsableArrow" />
              <i v-if="!showDetails" class="mdi mdi-menu-up superVerticalAlign collapsableArrow" />
            </div>
            <b-collapse id="collapse-details" v-model="showDetails">
              <p class="ml-2 mb-0 mt-2">
                <strong>Applicable - Configurable: </strong> {{ project.details.ac }} ({{
                  ((project.details.ac / project.details.total) * 100).toFixed(2)
                }}%)
              </p>
              <p class="ml-2 mb-0 mt-2">
                <strong>Applicable - Inherently Meets: </strong> {{ project.details.aim }} ({{
                  ((project.details.aim / project.details.total) * 100).toFixed(2)
                }}%)
              </p>
              <p class="ml-2 mb-0 mt-2">
                <strong>Applicable - Does Not Meet: </strong> {{ project.details.adnm }} ({{
                  ((project.details.adnm / project.details.total) * 100).toFixed(2)
                }}%)
              </p>
              <p class="ml-2 mb-0 mt-2">
                <strong>Not Applicable: </strong> {{ project.details.na }} ({{
                  ((project.details.na / project.details.total) * 100).toFixed(2)
                }}%)
              </p>
              <p class="ml-2 mb-0 mt-2">
                <strong>Not Yet Determined: </strong> {{ project.details.nyd }} ({{
                  ((project.details.nyd / project.details.total) * 100).toFixed(2)
                }}%)
              </p>
              <p class="ml-2 mb-0 mt-2">
                <strong>Not Under Review: </strong> {{ project.details.nur }} ({{
                  ((project.details.nur / project.details.total) * 100).toFixed(2)
                }}%)
              </p>
              <p class="ml-2 mb-0 mt-2">
                <strong>Under Review: </strong> {{ project.details.ur }} ({{
                  ((project.details.ur / project.details.total) * 100).toFixed(2)
                }}%)
              </p>
              <p class="ml-2 mb-0 mt-2">
                <strong>Locked: </strong> {{ project.details.lck }} ({{
                  ((project.details.lck / project.details.total) * 100).toFixed(2)
                }}%)
              </p>
              <p class="ml-2 mb-0 mt-2"><strong>Total: </strong> {{ project.details.total }}</p>
            </b-collapse>
          </b-col>
        </b-row>
        <b-row class="pb-4">
          <b-col>
            <div class="clickable" @click="showMetadata = !showMetadata">
              <h5 class="m-0 d-inline-block">Project Metadata</h5>

              <i
                v-if="showMetadata"
                class="mdi mdi-menu-down superVerticalAlign collapsableArrow"
              />
              <i v-if="!showMetadata" class="mdi mdi-menu-up superVerticalAlign collapsableArrow" />
            </div>
            <b-collapse id="collapse-metadata" v-model="showMetadata">
              <small
                v-if="
                  role_gte_to(effective_permissions, 'admin') &&
                  (!project.metadata || !project.metadata.hasOwnProperty('Slack Channel ID'))
                "
                class="text-muted"
              >
                For slack notification, you can add a metadata with key `Slack Channel ID` and the
                value will be the slack channel ID (e.g. C12345) or name (e.g. #general) you wish to
                notify.
              </small>
              <div v-for="(value, propertyName) in project.metadata" :key="propertyName">
                <p v-linkified class="ml-2 mb-0 mt-2">
                  <strong>{{ propertyName }}: </strong>{{ value }}
                </p>
              </div>
              <UpdateMetadataModal
                v-if="role_gte_to(effective_permissions, 'author')"
                :project="project"
                @projectUpdated="refreshProject"
              />
            </b-collapse>
          </b-col>
        </b-row>
        <b-row>
          <b-col>
            <div class="clickable" @click="showHistory = !showHistory">
              <h5 class="m-0 d-inline-block">Project History</h5>

              <i v-if="showHistory" class="mdi mdi-menu-down superVerticalAlign collapsableArrow" />
              <i v-if="!showHistory" class="mdi mdi-menu-up superVerticalAlign collapsableArrow" />
            </div>
            <b-collapse id="collapse-metadata" v-model="showHistory">
              <History :histories="project.histories" :revertable="false" />
            </b-collapse>
          </b-col>
        </b-row>
      </b-col>
    </b-row>
  </div>
</template>

<script>
import _ from "lodash";
import axios from "axios";
import DateFormatMixinVue from "../../mixins/DateFormatMixin.vue";
import FormMixinVue from "../../mixins/FormMixin.vue";
import AlertMixinVue from "../../mixins/AlertMixin.vue";
import RoleComparisonMixin from "../../mixins/RoleComparisonMixin.vue";
import History from "../shared/History.vue";
import MembershipsTable from "../memberships/MembershipsTable.vue";
import UpdateMetadataModal from "./UpdateMetadataModal.vue";
import ComponentCard from "../components/ComponentCard.vue";
import AddComponentModal from "../components/AddComponentModal.vue";
import NewComponentModal from "../components/NewComponentModal.vue";
import DiffViewer from "./DiffViewer.vue";
import RevisionHistory from "./RevisionHistory.vue";

export default {
  name: "Project",
  components: {
    History,
    MembershipsTable,
    UpdateMetadataModal,
    ComponentCard,
    AddComponentModal,
    NewComponentModal,
    DiffViewer,
    RevisionHistory,
  },
  mixins: [DateFormatMixinVue, AlertMixinVue, FormMixinVue, RoleComparisonMixin],
  props: {
    effective_permissions: {
      type: String,
    },
    initialProjectState: {
      type: Object,
      required: true,
    },
    current_user_id: {
      type: Number,
    },
    statuses: {
      type: Array,
      required: true,
    },
    severities: {
      type: Array,
      required: true,
    },
    available_roles: {
      type: Array,
      required: true,
    },
  },
  data: function () {
    return {
      showDetails: true,
      showMetadata: true,
      showHistory: true,
      project: this.initialProjectState,
      visible: this.initialProjectState.visibility === "discoverable",
      projectTabIndex: 0,
    };
  },
  computed: {
    sortedAvailableComponents: function () {
      return _.sortBy(this.project.available_components, ["child_project_name"], ["asc"]);
    },
    uniqueComponentNames: function () {
      return _.uniq(this.sortedComponents().map((c) => c["name"]));
    },
    adminList: function () {
      return this.project.admins.map((a) => `${a.name} <${a.email}>`).join(", ");
    },
    lastAudit: function () {
      return this.project.histories.slice(0, 1).pop();
    },
    breadcrumbs: function () {
      return [
        {
          text: "Projects",
          href: "/projects",
        },
        {
          text: this.project.name,
          active: true,
        },
      ];
    },
  },
  watch: {
    projectTabIndex: function (_) {
      localStorage.setItem(
        `projectTabIndex-${this.project.id}`,
        JSON.stringify(this.projectTabIndex)
      );
    },
  },
  mounted: function () {
    // Persist `currentTab` across page loads
    if (localStorage.getItem(`projectTabIndex-${this.project.id}`)) {
      try {
        this.$nextTick(
          () =>
            (this.projectTabIndex = JSON.parse(
              localStorage.getItem(`projectTabIndex-${this.project.id}`)
            ))
        );
      } catch (e) {
        localStorage.removeItem(`projectTabIndex-${this.project.id}`);
      }
    }
  },
  methods: {
    sortedComponents: function () {
      return _.orderBy(
        this.project.components,
        [(component) => component.name.toLowerCase(), "version", "release"],
        ["asc"]
      );
    },
    sortedOverlayComponents: function () {
      return this.sortedComponents().filter((e) => e.component_id != null);
    },
    sortedRegularComponents: function () {
      return this.sortedComponents().filter((e) => e.component_id == null);
    },
    refreshProject: function () {
      axios.get(`/projects/${this.project.id}`).then((response) => {
        this.project = response.data;
        this.visible = this.project.visibility === "discoverable";
      });
    },
    updateVisibility: function () {
      let payload = { project: { visibility: this.visible ? "discoverable" : "hidden" } };
      axios
        .put(`/projects/${this.project.id}`, payload)
        .then((response) => {
          this.alertOrNotifyResponse(response);
          this.refreshProject();
        })
        .catch(this.alertOrNotifyResponse);
    },
    // Having deleteComponent on the `ComponentCard` causes it to
    // disappear almost immediately because the component gets
    // destroyed once `refreshProject` executes
    deleteComponent: function (componentId) {
      axios
        .delete(`/components/${componentId}`)
        .then((response) => {
          this.alertOrNotifyResponse(response);
          this.refreshProject();
        })
        .catch(this.alertOrNotifyResponse);
    },
    downloadExport: function (type, componentsToExport) {
      if (type === "excel") {
        this.$refs["excel-export-modal"].hide();
      } else if (type === "disa_excel") {
        this.$refs["disa-excel-export-modal"].hide();
      }
      axios
        .get(`/projects/${this.project.id}/export/${type}?components_type=${componentsToExport}`)
        .then((_res) => {
          // Once it is validated that there is content to download, prompt
          // the user to save the file
          window.open(`/projects/${this.project.id}/export/${type}`);
        })
        .catch(this.alertOrNotifyResponse);
    },
  },
};
</script>

<style scoped></style>
